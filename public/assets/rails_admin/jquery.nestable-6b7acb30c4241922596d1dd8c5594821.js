/*!
 * Nestable jQuery Plugin - Copyright (c) 2012 David Bushell - http://dbushell.com/
 * Dual-licensed under the BSD or MIT licenses
 */
!function(e,t,n,i){function o(n,i){this.w=e(t),this.el=e(n),this.options=e.extend({},u,i),this.init()}var r="ontouchstart"in t,a=function(){var e=n.createElement("div"),i=n.documentElement;if(!("pointerEvents"in e.style))return!1;e.style.pointerEvents="auto",e.style.pointerEvents="x",i.appendChild(e);var o=t.getComputedStyle&&"auto"===t.getComputedStyle(e,"").pointerEvents;return i.removeChild(e),!!o}(),s=r?"touchstart":"mousedown",l=r?"touchmove":"mousemove",c=r?"touchend":"mouseup";eCancel=r?"touchcancel":"mouseup";var u={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};o.prototype={init:function(){var n=this;n.reset(),n.el.data("nestable-group",this.options.group),n.placeEl=e('<div class="'+n.options.placeClass+'"/>'),e.each(this.el.find(n.options.itemNodeName),function(t,i){n.setParent(e(i))}),n.el.on("click","button",function(t){if(!n.dragEl&&(r||0===t.button)){var i=e(t.currentTarget),o=i.data("action"),a=i.parent(n.options.itemNodeName);"collapse"===o&&n.collapseItem(a),"expand"===o&&n.expandItem(a)}});var i=function(t){var i=e(t.target);i.hasClass(n.options.handleClass)||(i=i.parents("."+n.options.handleClass).first()),!i.length||n.dragEl||!r&&0!==t.button||r&&1!==t.touches.length||(t.preventDefault(),n.dragStart(r?t.touches[0]:t))},o=function(e){n.dragEl&&(e.preventDefault(),n.dragMove(r?e.touches[0]:e))},a=function(e){n.dragEl&&(e.preventDefault(),n.dragStop(r?e.touches[0]:e))};r?(n.el[0].addEventListener(s,i,!1),t.addEventListener(l,o,!1),t.addEventListener(c,a,!1),t.addEventListener(eCancel,a,!1)):(n.el.on(s,i),n.w.on(l,o),n.w.on(c,a))},serialize:function(){var t,n=0,i=this;return step=function(t,n){var o=[],r=t.children(i.options.itemNodeName);return r.each(function(){var t=e(this),r=e.extend({},t.data()),a=t.children(i.options.listNodeName);a.length&&(r.children=step(a,n+1)),o.push(r)}),o},t=step(i.el.find(i.options.listNodeName).first(),n)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(e){e.removeClass(this.options.collapsedClass),e.children('[data-action="expand"]').hide(),e.children('[data-action="collapse"]').show(),e.children(this.options.listNodeName).show()},collapseItem:function(e){var t=e.children(this.options.listNodeName);t.length&&(e.addClass(this.options.collapsedClass),e.children('[data-action="collapse"]').hide(),e.children('[data-action="expand"]').show(),e.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(e(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(e(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(e(this.options.expandBtnHTML)),t.prepend(e(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(e){e.removeClass(this.options.collapsedClass),e.children("[data-action]").remove(),e.children(this.options.listNodeName).remove()},dragStart:function(t){var o=this.mouse,r=e(t.target),a=r.parents(this.options.itemNodeName).first();this.placeEl.css("height",a.height()),o.offsetX=t.offsetX!==i?t.offsetX:t.pageX-r.offset().left,o.offsetY=t.offsetY!==i?t.offsetY:t.pageY-r.offset().top,o.startX=o.lastX=t.pageX,o.startY=o.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=e(n.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",a.width()),a.after(this.placeEl),a[0].parentNode.removeChild(a[0]),a.appendTo(this.dragEl),e(n.body).append(this.dragEl),this.dragEl.css({left:t.pageX-o.offsetX,top:t.pageY-o.offsetY});var s,l,c=this.dragEl.find(this.options.itemNodeName);for(s=0;s<c.length;s++)l=e(c[s]).parents(this.options.listNodeName).length,l>this.dragDepth&&(this.dragDepth=l)},dragStop:function(){var e=this.dragEl.children(this.options.itemNodeName).first();e[0].parentNode.removeChild(e[0]),this.placeEl.replaceWith(e),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(t){var i,o,r,s,l,c=this.options,u=this.mouse;this.dragEl.css({left:t.pageX-u.offsetX,top:t.pageY-u.offsetY}),u.lastX=u.nowX,u.lastY=u.nowY,u.nowX=t.pageX,u.nowY=t.pageY,u.distX=u.nowX-u.lastX,u.distY=u.nowY-u.lastY,u.lastDirX=u.dirX,u.lastDirY=u.dirY,u.dirX=0===u.distX?0:u.distX>0?1:-1,u.dirY=0===u.distY?0:u.distY>0?1:-1;var d=Math.abs(u.distX)>Math.abs(u.distY)?1:0;if(!u.moving)return u.dirAx=d,u.moving=!0,void 0;u.dirAx!==d?(u.distAxX=0,u.distAxY=0):(u.distAxX+=Math.abs(u.distX),0!==u.dirX&&u.dirX!==u.lastDirX&&(u.distAxX=0),u.distAxY+=Math.abs(u.distY),0!==u.dirY&&u.dirY!==u.lastDirY&&(u.distAxY=0)),u.dirAx=d,u.dirAx&&u.distAxX>=c.threshold&&(u.distAxX=0,r=this.placeEl.prev(c.itemNodeName),u.distX>0&&r.length&&!r.hasClass(c.collapsedClass)&&(i=r.find(c.listNodeName).last(),l=this.placeEl.parents(c.listNodeName).length,l+this.dragDepth<=c.maxDepth&&(i.length?(i=r.children(c.listNodeName).last(),i.append(this.placeEl)):(i=e("<"+c.listNodeName+"/>").addClass(c.listClass),i.append(this.placeEl),r.append(i),this.setParent(r)))),u.distX<0&&(s=this.placeEl.next(c.itemNodeName),s.length||(o=this.placeEl.parent(),this.placeEl.parents(c.itemNodeName).first().after(this.placeEl),o.children().length||this.unsetParent(o.parent()))));var f=!1;if(a||(this.dragEl[0].style.visibility="hidden"),this.pointEl=e(n.elementFromPoint(t.pageX-n.body.scrollLeft,t.pageY-n.body.scrollTop)),a||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(c.handleClass)&&(this.pointEl=this.pointEl.parent(c.itemNodeName)),this.pointEl.hasClass(c.emptyClass))f=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(c.itemClass))return;var h=this.pointEl.parents("."+c.rootClass).first(),p=this.dragRootEl.data("nestable-id")!==h.data("nestable-id");if(!u.dirAx||p||f){if(p&&c.group!==h.data("nestable-group"))return;if(l=this.dragDepth-1+this.pointEl.parents(c.listNodeName).length,l>c.maxDepth)return;var m=t.pageY<this.pointEl.offset().top+this.pointEl.height()/2;o=this.placeEl.parent(),f?(i=e(n.createElement(c.listNodeName)).addClass(c.listClass),i.append(this.placeEl),this.pointEl.replaceWith(i)):m?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),o.children().length||this.unsetParent(o.parent()),this.dragRootEl.find(c.itemNodeName).length||this.dragRootEl.append('<div class="'+c.emptyClass+'"/>'),p&&(this.hasNewRoot=!0,this.dragRootEl=h)}}},e.fn.nestable=function(t){var n=this,i=this;return n.each(function(){var n=e(this).data("nestable");n?"string"==typeof t&&"function"==typeof n[t]&&(i=n[t]()):(e(this).data("nestable",new o(this,t)),e(this).data("nestable-id",(new Date).getTime()))}),i||n}}(window.jQuery||window.Zepto,window,document);